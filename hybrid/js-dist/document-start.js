function interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function createCommonjsModule(e,t){return t={exports:{}},e(t,t.exports),t.exports}function __extends(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function __decorate(e,t,n,r){var o,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,n,s):o(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __param(e,t){return function(n,r){t(n,r,e)}}function __awaiter(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}c((r=r.apply(e,t)).next())})}function receiveMessage(e,t){try{console.debug("Received incoming message from native, to port",e);var n=PortStore.findOrCreateByNativeIndex(e);if(!n)throw new Error("Tried to receive message on inactive port");var r=t.passedPortIds.map(function(e){return PortStore.findOrCreateByNativeIndex(e).jsMessagePort});console.debug("Posting message to native index",n.nativePortIndex),n.sendOriginalPostMessage(t.data,r)}catch(e){console.error(e)}}function postMessage(e,t){Promise.resolve().then(function(){return PromiseTools.map(t,function(e){var t=new MessagePortWrapper(e);return t.checkForNativePort().then(function(){return t.nativePortIndex})})}).then(function(t){promiseBridge.bridgePromise({operation:"postMessage",data:e,additionalPortIndexes:t})})}function processNewWorkerMatch(e){var t=serviceWorkerRecords[e.instanceId];return t?t.updateState(e.installState):(t=new HybridServiceWorker(e.instanceId,e.url,e.scope,e.installState),serviceWorkerRecords[e.instanceId]=t),RegistrationInstance.assignAccordingToInstallState(t),t}function refreshServiceWorkers(){serviceWorkerBridge.bridgePromise({operation:"getAll"}).then(function(e){e.forEach(function(e){serviceWorkerRecords[e.instanceId]=new HybridServiceWorker(e.instanceId,e.url,"",e.installState),RegistrationInstance.assignAccordingToInstallState(serviceWorkerRecords[e.instanceId])})})}var commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},index=createCommonjsModule(function(e){"use strict";function t(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function n(){}var r=Object.prototype.hasOwnProperty,o="function"!=typeof Object.create&&"~";n.prototype._events=void 0,n.prototype.eventNames=function(){var e,t=this._events,n=[];if(!t)return n;for(e in t)r.call(t,e)&&n.push(o?e.slice(1):e);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(t)):n},n.prototype.listeners=function(e,t){var n=o?o+e:e,r=this._events&&this._events[n];if(t)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var i=0,s=r.length,a=new Array(s);i<s;i++)a[i]=r[i].fn;return a},n.prototype.emit=function(e,t,n,r,i,s){var a=o?o+e:e;if(!this._events||!this._events[a])return!1;var c,l,u=this._events[a],f=arguments.length;if("function"==typeof u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),f){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,r),!0;case 5:return u.fn.call(u.context,t,n,r,i),!0;case 6:return u.fn.call(u.context,t,n,r,i,s),!0}for(l=1,c=new Array(f-1);l<f;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var d,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),f){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,n);break;default:if(!c)for(d=1,c=new Array(f-1);d<f;d++)c[d-1]=arguments[d];u[l].fn.apply(u[l].context,c)}}return!0},n.prototype.on=function(e,n,r){var i=new t(n,r||this),s=o?o+e:e;return this._events||(this._events=o?{}:Object.create(null)),this._events[s]?this._events[s].fn?this._events[s]=[this._events[s],i]:this._events[s].push(i):this._events[s]=i,this},n.prototype.once=function(e,n,r){var i=new t(n,r||this,!0),s=o?o+e:e;return this._events||(this._events=o?{}:Object.create(null)),this._events[s]?this._events[s].fn?this._events[s]=[this._events[s],i]:this._events[s].push(i):this._events[s]=i,this},n.prototype.removeListener=function(e,t,n,r){var i=o?o+e:e;if(!this._events||!this._events[i])return this;var s=this._events[i],a=[];if(t)if(s.fn)(s.fn!==t||r&&!s.once||n&&s.context!==n)&&a.push(s);else for(var c=0,l=s.length;c<l;c++)(s[c].fn!==t||r&&!s[c].once||n&&s[c].context!==n)&&a.push(s[c]);return a.length?this._events[i]=1===a.length?a[0]:a:delete this._events[i],this},n.prototype.removeAllListeners=function(e){return this._events?(e?delete this._events[o?o+e:e]:this._events=o?{}:Object.create(null),this):this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prototype.setMaxListeners=function(){return this},n.prefixed=o,"undefined"!=typeof e&&(e.exports=n)}),EventEmitter=interopDefault(index);Object.assign||function(e){for(var t,n=1;n<arguments.length;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e};var webkit=window.webkit,promiseCallbacks={},promiseBridges={};window.__promiseBridgeCallbacks=promiseCallbacks,window.__promiseBridges=promiseBridges,console.log("SET BRIDGE VARIABLE");var PromiseOverWKMessage=function(e){function t(t){if(e.call(this),this.callbackArray=[],this.name=t,!webkit.messageHandlers[t])throw new Error('Message handler "'+t+'" does not exist');if(webkit.messageHandlers[t]._receive)throw new Error('Promise bridge for "'+t+'" already exists"');promiseCallbacks[t]=this.receiveResponse.bind(this),promiseBridges[t]=this}return __extends(t,e),t.prototype.bridgePromise=function(e){for(var t=this,n=0;this.callbackArray[n];)n++;return new Promise(function(r,o){t.callbackArray[n]=[r,o],console.debug("Sending",{callbackIndex:n,message:e}),webkit.messageHandlers[t.name].postMessage({callbackIndex:n,message:e})})},t.prototype.emitWithResponse=function(e,t,n){var r=this,o=null,i=function(e){o=e},s={respondWith:i,arguments:t};this.emit(e,s),Promise.resolve(o).then(function(e){console.log("FULFILL",n),r.send({callbackResponseIndex:n,fulfillValue:e})}).catch(function(e){console.log("CATCH",n),r.send({callbackResponseIndex:n,rejectValue:e.toString()})})},t.prototype.send=function(e){webkit.messageHandlers[this.name].postMessage({message:e})},t.prototype.receiveResponse=function(e,t,n){try{var r=this.callbackArray[e];if(!r)throw new Error("Tried to use a callback that didn't exist, #"+e);console.log("Successfully used callback at index #"+e),this.callbackArray[e]=null;var o=r[0],i=r[1];t?i(new Error(t)):o(n)}catch(e){console.error(e)}},t}(EventEmitter),resolveUrl=createCommonjsModule(function(e,t){void function(n,r){"function"==typeof define&&define.amd?define(r):"object"==typeof t?e.exports=r():n.resolveUrl=r()}(commonjsGlobal,function(){function e(){var e=arguments.length;if(0===e)throw new Error("resolveUrl requires at least one argument; got none.");var t=document.createElement("base");if(t.href=arguments[0],1===e)return t.href;var n=document.getElementsByTagName("head")[0];n.insertBefore(t,n.firstChild);for(var r,o=document.createElement("a"),i=1;i<e;i++)o.href=arguments[i],r=o.href,t.href=r;return n.removeChild(t),r}return e})}),resolveURL=interopDefault(resolveUrl),activeMessagePorts=[],PortStore={add:function(e){if(activeMessagePorts.indexOf(e)>-1)throw new Error("Trying to add a port that's already been added");activeMessagePorts.push(e)},remove:function(e){activeMessagePorts.splice(activeMessagePorts.indexOf(e),1)},findByNativeIndex:function(e){var t=activeMessagePorts.filter(function(t){return t.nativePortIndex===e});return t[0]},findOrCreateByNativeIndex:function(e){if(!e&&0!==e)throw new Error("Must provide a native index");var t=PortStore.findByNativeIndex(e);if(t)return t;var n=new MessagePortWrapper;return n.nativePortIndex=e,console.debug("Created new web MessagePort for native index",e),PortStore.add(n),n},findOrWrapJSMesssagePort:function(e){var t=activeMessagePorts.filter(function(t){return t.jsMessagePort==e});if(1==t.length)return t[0];var n=new MessagePortWrapper(e);return n}};window.hybridPortStore=PortStore;var index$1=createCommonjsModule(function(e,t){"use strict";function n(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}var r={}.hasOwnProperty,o=function(e,t){function n(){this.constructor=e}for(var o in t)r.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i=t.TimeoutError=function(e){return this instanceof i?(Error.captureStackTrace?(i.__super__.constructor.apply(this,arguments),Error.captureStackTrace(this,this.constructor)):this.stack=new Error(e).stack,this.message=e,void(this.name="TimeoutError")):new i(e)};o(i,Error),t.delay=function(e){return new Promise(function(t){setTimeout(t,e)})},t.defer=function(){var e={};return e.promise=new Promise(function(t,n){e.resolve=t,e.reject=n}),e},t.series=function(e){var t=[];return e.reduce(function(e,n){return e.then(n).then(function(e){t.push(e)})},Promise.resolve()).then(function(){return t})},t.parallel=t.parallelLimit=function(e,t){return!t||t<1||t>=e.length?Promise.all(e.map(function(e){return Promise.resolve().then(e)})):new Promise(function(n,r){for(var o=[],i=0,s=0,a=!1,c=function c(){if(!(a||i>=e.length)){var l=i++,u=e[l];s++,Promise.resolve().then(u).then(function(r){o[l]=r,s--,i<e.length&&s<t?c():0===s&&n(o)},function(e){a||(a=!0,r(e))})}},l=0;l<t;l++)c()})},t.map=function(e,n,r){var o=r;(!r||r<1)&&(o=1),r>=e.length&&(o=e.length);var i=e.map(function(e,t){return function(){return n(e,t)}});return t.parallel(i,o)},t.timeout=function(e,n){return new Promise(function(r,o){var i=setTimeout(function(){i=null,o(new t.TimeoutError("Timeout: Promise did not resolve within "+n+" milliseconds"))},n);e.then(function(e){null!==i&&(clearTimeout(i),r(e))},function(e){null!==i&&(clearTimeout(i),o(e))})})},t.whilst=function(e,t){return new Promise(function(n,r){var o=null,i=function i(){try{e()?Promise.resolve().then(t).then(function(e){o=e,setTimeout(i,0)},r):n(o)}catch(e){r(e)}};i()})},t.doWhilst=function(e,n){var r=!0,o=function(){var e=r||n();return r=!1,e};return t.whilst(o,e)},t.retry=function(e,t){function r(e){return new Error("Unsupported argument type for 'times': "+("undefined"==typeof e?"undefined":n(e)))}var o=5,i=0,s=0,a=null;if("function"==typeof e)t=e;else if("number"==typeof e)o=+e;else{if("object"!==("undefined"==typeof e?"undefined":n(e)))return e?Promise.reject(r(e)):Promise.reject(new Error("No parameters given"));if("number"==typeof e.times)o=+e.times;else if(e.times)return Promise.reject(r(e.times));e.interval&&(i=+e.interval)}return new Promise(function(e,n){var r=function r(){Promise.resolve().then(function(){return t(a)}).then(e).catch(function(e){s++,a=e,o!==1/0&&s===o?n(a):setTimeout(r,i)})};r()})}}),PromiseTools=interopDefault(index$1),retry=index$1.retry,doWhilst=index$1.doWhilst,whilst=index$1.whilst,timeout=index$1.timeout,map=index$1.map,parallel=index$1.parallel,parallelLimit=index$1.parallelLimit,series=index$1.series,defer=index$1.defer,delay=index$1.delay,TimeoutError=index$1.TimeoutError,webkit$1=window.webkit,promiseBridge=new PromiseOverWKMessage("messageChannel");window.__messageChannelBridge=promiseBridge,promiseBridge.addListener("emit",receiveMessage),promiseBridge.addListener("delete",function(e){console.debug("Deleting port store entry at index",e);var t=PortStore.findByNativeIndex(e);PortStore.remove(t)});var MessagePortWrapper=function(){function e(e){var t=this;void 0===e&&(e=null),this.nativePortIndex=null,e?(console.debug("Creating wrapper for an existing MessagePort"),this.jsMessagePort=e,this.jsMessagePort.postMessage=this.handleJSMessage.bind(this)):(console.debug("Making wrapper for a new web MessagePort"),this.jsMessageChannel=new MessageChannel,this.jsMessagePort=this.jsMessageChannel.port1,this.jsMessageChannel.port2.onmessage=function(e){t.handleJSMessage(e.data,e.ports)}),this.originalJSPortClose=this.jsMessagePort.close}return e.prototype.sendOriginalPostMessage=function(e,t){MessagePort.prototype.postMessage.apply(this.jsMessagePort,[e,t])},e.prototype.handleJSMessage=function(e,t,n){var r=this;void 0===n&&(n=!1),console.debug("Posting new message...");var o=[];t&&(o=t.map(function(e){return PortStore.findOrWrapJSMesssagePort(e)})),this.checkForNativePort().then(function(){return console.debug("Checking that additional ports have native equivalents"),PromiseTools.map(o,function(e){return e.checkForNativePort()})}).then(function(){promiseBridge.bridgePromise({operation:"sendToPort",portIndex:r.nativePortIndex,data:e,isExplicitPost:n,additionalPortIndexes:o.map(function(e){return e.nativePortIndex})})}).catch(function(e){console.error(e)})},e.prototype.checkForNativePort=function(){var e=this;return null!==this.nativePortIndex?Promise.resolve():promiseBridge.bridgePromise({operation:"create"}).then(function(t){console.debug("Created new native MessagePort at index ",String(t)),e.nativePortIndex=t,PortStore.add(e)})},e}(),promiseBridge$1=new PromiseOverWKMessage("notifications"),notification={permission:"unknown",requestPermission:function(e){return promiseBridge$1.bridgePromise({operation:"requestPermission"}).then(function(t){return e&&e(t),t})},prototype:{image:"",video:"",canvas:""}};promiseBridge$1.bridgePromise({operation:"getStatus"}).then(function(e){notification.permission=e}),promiseBridge$1.on("notification-permission-change",function(e){notification.permission=status}),window.Notification=notification;var ServiceWorkerInstallState,HybridPushManager=function(){function e(){}return e.prototype.subscribe=function(){return Promise.resolve(null)},e.prototype.getSubscription=function(){return Promise.resolve(null)},e.prototype.hasPermission=function(){return this.permissionState()},e.prototype.permissionState=function(){var e=notification.permission;return"default"==e&&(e="prompt"),Promise.resolve(e)},e}(),serviceWorkerBridge=new PromiseOverWKMessage("serviceWorker"),EventEmitterToJSEvent=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.addEventListener=function(e,t,n){this.addListener(e,t)},t.prototype.dispatchEvent=function(e){return this.emit(e.type,e),!0},t.prototype.removeEventListener=function(e,t){this.removeListener(e,t)},t}(EventEmitter),HybridServiceWorker=function(e){function t(t,n,r,o){var i=this;e.call(this),this._id=t,this.scriptURL=n,this.scope=r,this.installState=o,this.addListener("message",function(e){i.onmessage&&i.onmessage(e)})}return __extends(t,e),Object.defineProperty(t.prototype,"state",{get:function(){if(this.installState===ServiceWorkerInstallState.Activated)return"activated";if(this.installState===ServiceWorkerInstallState.Activating)return"activating";if(this.installState===ServiceWorkerInstallState.Installed)return"installed";if(this.installState===ServiceWorkerInstallState.Installing)return"installing";if(this.installState===ServiceWorkerInstallState.Redundant)return"redundant";throw new Error("Unrecognised install state:"+this.installState)},enumerable:!0,configurable:!0}),t.prototype.updateState=function(e){e!==this.installState&&(this.installState=e,this.onstatechange&&this.onstatechange({target:this}))},t.prototype.postMessage=function(e,t){if(RegistrationInstance.active!==this)throw new Error("Can only postMessage to active service worker");var n=[];if(t.length>1||1===t.length&&t[0]instanceof MessagePort==!1)throw new Error("Currently only supports sending one MessagePort");1===t.length&&n.push(t[0]),postMessage(e,n)},t.prototype.terminate=function(){throw new Error("Should not implement this.")},t}(EventEmitterToJSEvent),HybridRegistration=function(e){function t(){var t=this;e.call(this),this.addListener("updatefound",function(){t.onupdatefound&&t.onupdatefound()}),this.pushManager=new HybridPushManager}return __extends(t,e),t.prototype.getMostRecentWorker=function(){return this.active||this.waiting||this.installing},t.prototype.update=function(){serviceWorkerBridge.bridgePromise({operation:"update",url:this.getMostRecentWorker().scriptURL})},Object.defineProperty(t.prototype,"scope",{get:function(){return this.active.scope},enumerable:!0,configurable:!0}),t.prototype.unregister=function(){throw new Error("not yet")},t.prototype.clearAllInstancesOfServiceWorker=function(e){this.active===e&&(this.active=null),this.installing===e&&(this.installing=null),this.waiting===e&&(this.waiting=null)},t.prototype.assignAccordingToInstallState=function(e){this.clearAllInstancesOfServiceWorker(e),e.installState!==ServiceWorkerInstallState.Activated||this.active||(this.active=e,ServiceWorkerContainer.controller=e),e.installState===ServiceWorkerInstallState.Installed&&(this.waiting=e),e.installState===ServiceWorkerInstallState.Installing&&(this.installing=e,this.emit("updatefound",e))},t}(EventEmitterToJSEvent),RegistrationInstance=new HybridRegistration,HybridServiceWorkerContainer=function(e){function t(){var t=this;e.call(this),this.addListener("controllerchange",function(){t.oncontrollerchange&&t.oncontrollerchange()}),this.addListener("message",function(e){console.log("FIRED MESSAGE",t.onmessage),t.controller&&t.controller.dispatchEvent(e),t.onmessage&&t.onmessage(e)}),this.controller=RegistrationInstance.active}return __extends(t,e),Object.defineProperty(t.prototype,"ready",{get:function(){var e=this;return this.controller?(console.info("ServiceWorker ready returning immediately with activated instance"),Promise.resolve(RegistrationInstance)):new Promise(function(t,n){console.info("ServiceWorker ready returning promise and waiting..."),e.once("controllerchange",function(){console.debug("ServiceWorker ready received response"),t(RegistrationInstance)})})},enumerable:!0,configurable:!0}),t.prototype.register=function(e,t){var n=resolveURL(window.location.href,e);return console.info("Attempting to register service worker at",n),serviceWorkerBridge.bridgePromise({operation:"register",swPath:n,scope:t?t.scope:null}).then(function(e){processNewWorkerMatch(e);return RegistrationInstance}).catch(function(e){return console.error(e),null})},t.prototype.claimedByNewWorker=function(e){RegistrationInstance.clearAllInstancesOfServiceWorker(e),RegistrationInstance.active=e,this.controller=e,this.emit("controllerchange",e)},t.prototype.getRegistration=function(e){return Promise.resolve(RegistrationInstance)},t.prototype.getRegistrations=function(){return Promise.resolve([RegistrationInstance])},t}(EventEmitterToJSEvent),ServiceWorkerContainer=new HybridServiceWorkerContainer;!function(e){e[e.Installing=0]="Installing",e[e.Installed=1]="Installed",e[e.Activating=2]="Activating",e[e.Activated=3]="Activated",e[e.Redundant=4]="Redundant"}(ServiceWorkerInstallState||(ServiceWorkerInstallState={}));var serviceWorkerRecords={};serviceWorkerBridge.addListener("sw-change",processNewWorkerMatch),serviceWorkerBridge.addListener("claimed",function(e){var t=processNewWorkerMatch(e);console.log("Claimed by new worker"),ServiceWorkerContainer.claimedByNewWorker(t)}),refreshServiceWorkers(),serviceWorkerBridge.on("postMessage",function(e,t){console.log("Received message from worker?");for(var n=[],r=[],o=function(e){var t=new MessageChannel;r[e]=null,t.port2.onmessage=function(t){console.log("RECEIVED PORT WRITE",e,t.data),r[e]=t.data},n.push(t)},i=0;i<t;i++)o(i);var s=n.map(function(e){return e.port1}),a=new MessageEvent("message",{data:e,ports:s}),c=null;a.waitUntil=function(e){c=e},ServiceWorkerContainer.dispatchEvent(a)});var navigatorAsAny=navigator;navigatorAsAny.serviceWorker=ServiceWorkerContainer;var promiseBridge$2=new PromiseOverWKMessage("console"),makeSuitable=function(e){if(e instanceof Error)return e.toString();if("string"==typeof e)return e;if(null===e||void 0===e)return"null";var t="(not stringifyable): ";try{t=JSON.stringify(e)}catch(e){t+=e.toString()}return t},levels=["debug","info","log","error","warn"],console$1={},originalConsole=window.console;window.console=console$1,levels.forEach(function(e){console$1[e]=function(){originalConsole&&originalConsole[e].apply(originalConsole,arguments);var t=Array.from(arguments).map(makeSuitable);promiseBridge$2.send({level:e,args:t})}});var eventsBridge=new PromiseOverWKMessage("events");window.hybridEvents={emit:function(e,t){eventsBridge.send({name:e,data:t})}};var webkit$2=window.webkit;document.addEventListener("readystatechange",function(){console.log("NEW READYSTATE:",document.readyState),webkit$2.messageHandlers.readyStateHandler.postMessage(document.readyState)}),window.onerror=function(e){console.error(e)},console.info("Webview layer load complete.");